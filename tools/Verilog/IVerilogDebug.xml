<?xml version="1.0" encoding="UTF-8"?>
<vdt-project>

	<interface name="IVerilogDebug" extends="FPGAPprojectInterface">
		<!-- Syntax definitions -->

		<syntax name="D_ParamSyntax" format="-D%%ParamName" />
		<syntax name="g_ParamSyntax" format="-g%%ParamName" />
		<syntax name="NospecifySyntax" format="-gno-specify" />
		<syntax name="TopModuleSyntax" format="-s%%TopModule" />
		<syntax name="TopModulesOtherSyntax" format="%(-s%%ParamValue%| %)" />
		<syntax name="ModuleLibrarySyntax" format="%(-y%%ParamValue%| %)" />
		<syntax name="ExtraFilesSyntax" format="%(%%ParamValue%| %)" />
		<syntax name="SwitchSyntax" format="-%%ParamName" />
		<syntax name="GrepFindSyntax"
			format="| { grep --line-buffered -E &quot;%%ParamValue&quot; || true; }" />
		<syntax name="GrepSkipSyntax"
			format="| { grep --line-buffered -v &quot;%%ParamValue&quot; || true; }" />
		<syntax name="LogFileSyntax" format="%%ParamValue-%%BuildStamp.log" />
		<syntax name="OutputFileSyntax" format="%%ParamValue-%%BuildStamp.ivlg" />
		<syntax name="LxtFileSyntax" format="%%ParamValue-%%BuildStamp.lxt" />
		
		<syntax name="LogFileLatestSyntax"    format="ln -sf %%ParamValue-%%BuildStamp.log %%ParamValue-latest.log;" />
		<syntax name="OutputFileLatestSyntax" format="ln -sf %%ParamValue-%%BuildStamp.ivlg %%ParamValue-latest.ivlg;" />
		<syntax name="LxtFileLatestSyntax"    format="ln -sf %%ParamValue-%%BuildStamp.lxt %%ParamValue-latest.lxt;" />
		
		<syntax name="LxtParamFileSyntax"
			format="parameter lxtname=&quot;%%ParamValue-%%BuildStamp.lxt&quot;;" />
		<syntax name="IncludeParamSyntax" format="%(%%ParamValue%|\n%)" />
		
		<!-- Types definitions -->

		<typedef name="ModuleLibraryType" list="true">
			<paramtype kind="string" default="" textkind="dir"
				maxlength="256" sensitivity="sensitive" />
		</typedef>
		<typedef name="SwitchType">
			<paramtype kind="bool" formatTrue="-%%ParamName"
				formatFalse="" />
		</typedef>
		<typedef name="D_ParamType">
			<paramtype kind="bool" formatTrue="-D%%ParamName"
				formatFalse="" />
		</typedef>
		<typedef name="g_ParamType">
			<paramtype kind="bool" formatTrue="-g%%ParamName"
				formatFalse="" />
		</typedef>

	</interface>
<!-- 	
	<project name="FPGA_project" label="Project parameters for FPGA_project"
		interface="project_interface">

		<parameter id="SimulationTopFile" label="Project top simulation file"
			type="Filename" default="default_top (testing)" format="CopyValue"
			readonly="false" />

		<parameter id="SimulationTopModule" label="Project top simulation module"
			type="String" default="" format="CopyValue" readonly="false" />

		<parameter id="BuildDir" label="project build directory"
			type="Pathname" default="build" format="CopyValue" readonly="false" />

		<input>
			<group name="General" label="Project properties">
				"SimulationTopFile"
				"SimulationTopModule"
				"BuildDir"
			</group>
		</input>
		<output>
		</output>
	</project>

 -->

	<tool name="iverilog_dbg" project="FPGA_project" label="Icarus Verilog compiler - debug"
		exe="iverilog" shell="?%%OS: Windows=shell:, Linux=/bin/bash"
		package="FPGA_package"
		interface="IVerilogDebug" errors="(.*):([0-9]+): [a-z_\- ]*error: (.*)"
		warnings="(.*):([0-9]+): [a-z_\- ]*warning: (.*)" info="(.*):([0-9]+): [a-z_\-  ]*info: (.*)"> <!--do not actually exist -->

		<extensions-list>
			<extension mask="v" />
			<extension mask="tf" />
		</extensions-list>

		<action-menu>
			<action label="Simulate" resource="%SimulationTopFile"
				check-extension="false" check-existence="true" icon="iverilog.ico" />
			<action label="Simulate for" resource="%%SelectedFile"
				check-extension="true" check-existence="true" />
			<action label="Verify" resource="%%SelectedFile"
				check-extension="true" check-existence="true" icon="newmod_wiz.gif" />
			<action label="Empty" resource="" icon="sample.gif" />
			<action label="Just try for" resource="%%OS" />
		</action-menu>

		<parameter id="Param_Shell_Options" label="Param_Shell_Options"
			type="String" format="CopyValue" default="-c" readonly="false"
			visible="true" />

		<parameter id="Param_PreExe" label="Param_PreExe" type="String"
			format="CopyValue" default="" readonly="false" visible="true" />

		<parameter id="Param_Exe" label="Param_Exe" type="Filename"
			format="CopyValue" default="/usr/bin/iverilog" readonly="false"
			visible="true" />

		<parameter id="Param_TopModule" label="Top module extracted from the chosen target file"
			type="String" format="TopModuleSyntax" default="%%TopModule"
			readonly="true" visible="true" />

		<parameter id="TopModulesOther" type="Stringlist"
			format="TopModulesOtherSyntax" default="" omit=""
			label="Select top modules not referenced by the chosen target"
			readonly="false" visible="true" />

		<parameter id="ModuleLibrary" type="ModuleLibraryType"
			format="ModuleLibrarySyntax" default="" label="Select additional libraries to include"
			omit="" readonly="false" visible="true" />


		<parameter id="ExtraFiles" type="Filelist" format="ExtraFilesSyntax"
			default="" label="Select additional files to include" readonly="false"
			visible="true" />


		<parameter id="legacy_model" outid="legacy_model" type="D_ParamType"
			format="D_ParamSyntax" default="true" label="Use legacy model" />

		<parameter id="no_specify" outid="no-specify" type="g_ParamType"
			format="NospecifySyntax" default="true" label="Use no-specify" />
			
		<!-- -->
		
		<parameter id="v" type="SwitchType" format="SwitchSyntax"
			default="true" label="Verbose" />

		<parameter id="Param_SourceList" label="Param_SourceList"
			type="Stringlist" format="SourceListSyntax" default="" readonly="true"
			visible="true" />


		<parameter id="ShowNoProblem" type="BoolYesNo" format="None"
			default="false" label="Show output with no errors/warnings" />

		<parameter id="ShowWarnings" type="BoolYesNo" format="None"
			default="false" label="Show output warnings" />

		<parameter id="RemoveBugs" type="BoolYesNo" format="None"
			default="false" label="Remove buggy simulator output" />

		<parameter id="SaveLogsPreprocessor" type="BoolYesNo"
			format="None" default="false" label="Save simulator preprocessor log output" />

		<parameter id="SaveLogsSimulator" type="BoolYesNo" format="None"
			default="false" label="Save simulator log output" />

		<parameter id="ShowWaves" type="BoolYesNo" format="None"
			default="true" label="Show simulation result in waveform viewer" />

		<!-- Advanced Section -->


		<parameter id="LogFile" label="Simulator log file prefix"
			type="String" default="%%CurrentFileBase" format="LogFileSyntax"
			readonly="false" />
		<parameter id="OutFile" label="Simulator intermediate file prefix"
			type="String" default="%%CurrentFileBase" format="OutputFileSyntax"
			readonly="false" />
		<parameter id="LxtDumpFile" label="Simulator LXT dump file prefix"
			type="String" default="%%CurrentFileBase" format="LxtFileSyntax"
			readonly="false" />

		<parameter id="GTKWaveSavFile" label="GTKWave sav file"
			type="Filename" default="%%CurrentFileBase.sav" format="CopyValue"
			omit="" readonly="false" />

		<parameter id="GrepFindErr" label="Grep pattern for errors only"
			type="String" format="GrepFindSyntax" default="error" readonly="false"
			visible="true" />

		<parameter id="GrepFindErrWarn" label="Grep pattern for both errors and warnings"
			type="String" format="GrepFindSyntax" default="error|warning"
			readonly="false" visible="true" />

		<parameter id="GrepSkip1" label="Grep skip pattern" type="String"
			format="GrepSkipSyntax" default="(null)" readonly="false" visible="true" />
			
		<parameter id="IVerilogOther" label="Other IVerilog options"
			type="String" format="CopyValue" default="" omit=""
			readonly="false" visible="true" />

		<parameter id="IncludeParametersList" type="Stringlist"
			format="IncludeParamSyntax" default="" omit=""
			label="Verilog parameters definition to be included in the test fixture"
			readonly="false" visible="true" />
			
<!-- Temporary inserted into the command line, will be removed -->

		<parameter id="Param_1" label="Param_1" type="String"
			format="CopyValue" default="" omit="" readonly="false" visible="true" />

		<parameter id="Param_2" label="Param_2" type="String"
			format="CopyValue" default="" omit="" readonly="false" visible="true" />

		<parameter id="Param_3" label="Param_3" type="String"
			format="CopyValue" default="" omit="" readonly="false" visible="true" />

		<parameter id="Param_4" label="Param_4" type="String"
			format="CopyValue" default="" omit="" readonly="false" visible="true" />
			
			
		<!-- Invisible parameters, just pass calculated default values -->
		
		<parameter id="IVerilogActionIndex" type="String"
			format="CopyValue" visible="false" default="%%ChosenActionIndex" />

		<parameter id="SourceList" type="Stringlist" format="SourceListSyntax"
			default="" readonly="true" visible="false" />

		<parameter id="iverilog_include_file" type="Filename"
			default="IVERILOG_INCLUDE.v" format="CopyValue" visible="false" />

		<parameter id="LxtDumpFileParameter" type="String"
			default="%LxtDumpFile" format="LxtParamFileSyntax" visible="false" />
			
		<parameter id="LogFileLatest" type="String"
			default="%LogFile" format="LogFileLatestSyntax" visible="false" />
		<parameter id="OutFileLatest" type="String"
			default="%OutFile" format="OutputFileLatestSyntax" visible="false" />
		<parameter id="LxtDumpFileLatest" type="String"
			default="%LxtDumpFile" format="LxtFileLatestSyntax" visible="false" />
			
			
			

		<input>
			<group name="files" label="Files">
				<!-- "SimulationTopFile" -->
				"Param_TopModule"
				"TopModulesOther"
				"ExtraFiles"
				"ModuleLibrary"
				"GTKWaveSavFile"
				"IncludeParametersList"
			</group>
			<group name="options" label="Options">
				"ShowWaves"
				"ShowNoProblem"
				"ShowWarnings"
				"RemoveBugs"
				"SaveLogsPreprocessor"
				"SaveLogsSimulator"
				"v"
				"legacy_model"
				"no_specify"
			</group>
			<group name="Advanced" label="Advanced">
				"Param_PreExe"
				"Param_Exe"
				"Param_Shell_Options"
				"IVerilogOther"
				"LogFile"
				"OutFile"
				"LxtDumpFile"
				"GrepFindErr"
				"GrepFindErrWarn"
				"GrepSkip1"
				"Param_1"
				"Param_2"
				"Param_3"
				"Param_4"
			</group>
		</input>
		<output>
		<!-- TODO: watch for new lines inserted inside quoted tokens during autoformat - they break output
		Maybe add filter to the code to transform white spaces -->
			<line name="command_line" sep=" ">
				"%Param_Shell_Options"
				"%Param_PreExe"
				<if SaveLogsPreprocessor="true"
				    SaveLogsSimulator="true">
					"touch"
					"%LogFile"
					";"
					"%LogFileLatest"
				</if>
				
				"trap 'killall iverilog; ' EXIT;"
				"echo 'current PID='$$;"
				"%Param_Exe"
				"-o"
				<if IVerilogActionIndex="2">
					"/dev/null"
				</if>
				<if-not IVerilogActionIndex="2">
					"%OutFile"
				</if-not>
				" -D IVERILOG"
				"%IVerilogOther"
				"%Param_TopModule"
				"%TopModulesOther"
				"%ModuleLibrary"
				"%legacy_model"
				"%no_specify"
				"%v"
				"%SourceList"
				"%ExtraFiles"
				<if ShowNoProblem="false">
					"2&gt;&amp;1"
				</if>
				<if SaveLogsPreprocessor="true">
					"| tee -a"
					"%LogFile"
				</if>
				<if ShowNoProblem="false">
					<if ShowWarnings="true">
						"%GrepFindErrWarn"
					</if>
					<if ShowWarnings="false">
						"%GrepFindErr"
					</if>
					<if RemoveBugs="true">
						"%GrepSkip1"
					</if>
				</if>
				"|| { echo '*** iverilog failed ***'; exit 1; } ;"
				"trap '' EXIT;"
				<if-not IVerilogActionIndex="2">
				    "%OutFileLatest" 
					<!-- "time vvp -v" -->
					"%Param_1"
					"trap 'killall vvp; ' EXIT;"
					"vvp -v"
					"%Param_2"
					"%OutFile"
					"-lxt2 "
					<if SaveLogsSimulator="true">
						"| tee -a"
						"%LogFile"
					</if>
					"|| { echo '*** vvp failed ***'; exit 1; } ;"
					"%LxtDumpFileLatest"
					 <!-- no trap for GTKWave -->
					"trap '' EXIT;"
					<!-- "%Param_2" -->
					"%Param_3"
					<if ShowWaves="true">
						"gtkwave"
						"%LxtDumpFile"
						"%GTKWaveSavFile"
						"&amp; "
					</if>
					"%Param_4"
				</if-not>
			</line>
			<line name="IverilogIncludeFile" dest="iverilog_include_file"
				sep="\n">
				"%LxtDumpFileParameter"
				"%IncludeParametersList"
			</line>
		</output>


	</tool>

</vdt-project>
